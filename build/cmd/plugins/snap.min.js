define(function(n,o,s){"use strict";var e=n("../util"),a=n("../base"),t=function(n){t.superclass.constructor.call(this,n),this.userConfig=e.mix({snapColIndex:0,snapRowIndex:0,snapDuration:500,snapEasing:"ease",snapOffsetLeft:0,snapOffsetTop:0,autoStep:!1},n)};if(e.extend(t,a,{pluginId:"snap",pluginInitializer:function(n){var o=this;o.xscroll=n.render(),o.snapColIndex=o.userConfig.snapColIndex,o.snapRowIndex=o.userConfig.snapRowIndex,o.render()},pluginDestructor:function(){var n=this,o=n.xscroll;o.on("panend",o._onpanend,o),o.off("panend",n._snapAnimate,n)},snapTo:function(n,o,s,e,a){return this.snapToCol(n,s,e,a),this.snapToRow(o,s,e,a),this},snapToCol:function(n,o,s,e){var a=this,t=a.userConfig,o=o||t.snapDuration,s=s||t.snapEasing,r=t.snapWidth,i=t.snapColsNum,l=t.snapOffsetLeft;n=n>=i?i-1:0>n?0:n,a.prevColIndex=a.snapColIndex,a.snapColIndex=n;var p=a.snapColIndex*r+l;return a.xscroll.scrollLeft(p,o,s,e),a},_colChange:function(n){var o=this;return o.prevColIndex!=o.snapColIndex&&o.trigger("colchange",e.mix(n,{type:"colchange",curColIndex:o.snapColIndex,prevColIndex:o.prevColIndex})),o},snapToRow:function(n,o,s,e){var a=this,t=a.userConfig,o=o||t.snapDuration,s=s||t.snapEasing,r=t.snapHeight,i=t.snapRowsNum,l=t.snapOffsetTop;n=n>=i?i-1:0>n?0:n,a.prevRowIndex=a.snapRowIndex,a.snapRowIndex=n;var p=a.snapRowIndex*r+l;return a.xscroll.scrollTop(p,o,s,e),a},_rowChange:function(n){var o=this;return o.prevRowIndex!=o.snapRowIndex&&o.trigger("rowchange",e.mix(n,{type:"rowchange",curRowIndex:o.snapRowIndex,prevRowIndex:o.prevRowIndex})),o},_snapAnimate:function(n){var o=this,s=o.userConfig,e=s.snapWidth,a=s.snapHeight;o.xscroll.__topstart=null,o.xscroll.__leftstart=null;var t=n.direction;if(Math.abs(n.velocity)<=.2){var r=Math.abs(o.xscroll.getScrollLeft()),i=Math.abs(o.xscroll.getScrollTop()),l=Math.round(r/e),p=Math.round(i/a);o.snapTo(l,p)}else if(s.autoStep){var d=o.xscroll.computeScroll("x",n.velocityX),u=o.xscroll.computeScroll("y",n.velocityY),l=d&&d.pos?Math.round(d.pos/e):o.snapColIndex,p=u&&u.pos?Math.round(u.pos/a):o.snapRowIndex,c=Math.ceil(d&&d.duration,u&&u.duration);d&&"inside"==d.status?o.snapToCol(l,c,d&&d.easing,function(){o.xscroll.boundryCheckX()}):d&&o.xscroll.scrollLeft(d.pos,d.duration,d.easing,function(){o.xscroll.boundryCheckX(),o.prevColIndex=o.snapColIndex,o.snapColIndex=Math.round(Math.abs(o.xscroll.getScrollLeft())/e)}),u&&"inside"==u.status?o.snapToRow(p,c,u&&u.easing,function(){o.xscroll.boundryCheckY()}):u&&o.xscroll.scrollTop(u.pos,u.duration,u.easing,function(){o.xscroll.boundryCheckY(),o.prevRowIndex=o.snapRowIndex,o.snapRowIndex=Math.round(Math.abs(o.xscroll.getScrollTop())/a)})}else 2==t?o.snapColIndex++:4==t?o.snapColIndex--:void 0,8==t?o.snapRowIndex++:16==t?o.snapRowIndex--:void 0,o.snapTo(o.snapColIndex,o.snapRowIndex)},render:function(){var n=this,o=n.xscroll;return n.userConfig.snapWidth=n.userConfig.snapWidth||o.width||100,n.userConfig.snapHeight=n.userConfig.snapHeight||o.height||100,n.userConfig.snapColsNum=n.userConfig.snapColsNum||Math.max(Math.round(o.containerWidth/o.width),1),n.userConfig.snapRowsNum=n.userConfig.snapRowsNum||Math.max(Math.round(o.containerHeight/o.height),1),o.off("panend",o._onpanend),o.on("panend",n._snapAnimate,n),n._bindEvt(),n},_bindEvt:function(){var n=this,o=n.xscroll;n._isEvtBinded||(n._isEvtBinded=!0,o.on("scrollend",function(s){"y"!=s.zoomType||o.isBoundryOutTop()||o.isBoundryOutBottom()||n._rowChange(s)}),o.on("scrollend",function(s){"x"!=s.zoomType||o.isBoundryOutLeft()||o.isBoundryOutRight()||n._colChange(s)}))}}),"object"==typeof s&&s.exports)s.exports=t;else if(window.XScroll&&window.XScroll.Plugins)return XScroll.Plugins.Snap=t});